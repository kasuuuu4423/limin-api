<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limin API Test UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; color: #212529; }
        .card { background: #fff; border: 1px solid #dee2e6; }
        .card-header { background: #e9ecef; border-bottom: 1px solid #dee2e6; color: #212529; }
        .form-control { background: #fff; color: #212529; border-color: #ced4da; }
        .form-control:focus { background: #fff; color: #212529; border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-label { color: #212529; }
        .btn-primary { background: #0d6efd; border-color: #0d6efd; }
        .btn-primary:hover { background: #0b5ed7; border-color: #0a58ca; }
        .btn-danger { background: #dc3545; border-color: #dc3545; }
        .btn-danger:hover { background: #bb2d3b; border-color: #b02a37; }
        .btn-success { background: #198754; border-color: #198754; }
        .btn-success:hover { background: #157347; border-color: #146c43; }
        pre { background: #212529; padding: 1rem; border-radius: 0.5rem; color: #7ee787; font-size: 0.85rem; max-height: 300px; overflow: auto; }
        .token-display { word-break: break-all; font-family: monospace; font-size: 0.8rem; color: #6c757d; }
        h1 { color: #0d6efd; }
        .text-muted { color: #6c757d !important; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">Limin API Test UI</h1>
        
        <div class="row g-4">
            <!-- 認証 -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <strong>1. 認証</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" class="form-control" value="test@example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" id="password" class="form-control" value="password">
                        </div>
                        <button class="btn btn-primary" onclick="getToken()">トークン取得</button>
                        <button class="btn btn-secondary ms-2" onclick="logout()">ログアウト</button>
                        <div class="mt-3">
                            <small class="text-muted">現在のトークン:</small>
                            <div id="currentToken" class="token-display text-muted">未取得</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Capture -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <strong>2. Capture (1行登録)</strong>
                        <small class="text-muted ms-2">POST /capture</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Text</label>
                            <input type="text" id="captureText" class="form-control" placeholder="明日までに企画書を送る">
                        </div>
                        <button class="btn btn-primary" onclick="capture()">登録</button>
                    </div>
                </div>
            </div>

            <!-- Item削除 -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <strong>3. Item削除</strong>
                        <small class="text-muted ms-2">DELETE /item/{id}</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Item ID</label>
                            <input type="text" id="deleteItemId" class="form-control" placeholder="UUID">
                        </div>
                        <button class="btn btn-danger" onclick="deleteItem()">削除</button>
                    </div>
                </div>
            </div>

            <!-- nextAction更新 -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <strong>4. nextAction更新</strong>
                        <small class="text-muted ms-2">POST /item/{id}/next-action</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Item ID</label>
                            <input type="text" id="updateItemId" class="form-control" placeholder="UUID">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Next Action</label>
                            <input type="text" id="nextAction" class="form-control" placeholder="まず目次だけ書く">
                        </div>
                        <button class="btn btn-success" onclick="updateNextAction()">更新</button>
                    </div>
                </div>
            </div>

            <!-- レスポンス -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Response</strong>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">Clear</button>
                    </div>
                    <div class="card-body">
                        <pre id="response">// ここにレスポンスが表示されます</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('limin_token') || '';
        
        if (token) {
            document.getElementById('currentToken').textContent = token.substring(0, 30) + '...';
        }

        // CSRF cookie を取得
        async function getCsrfCookie() {
            await fetch('/sanctum/csrf-cookie', { credentials: 'same-origin' });
        }

        function getCsrfToken() {
            const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
            return match ? decodeURIComponent(match[1]) : '';
        }

        function log(method, url, status, data) {
            const time = new Date().toLocaleTimeString();
            const pre = document.getElementById('response');
            const entry = `[${time}] ${method} ${url}\nStatus: ${status}\n${JSON.stringify(data, null, 2)}\n${'─'.repeat(50)}\n`;
            pre.textContent = entry + pre.textContent;
        }

        function clearLog() {
            document.getElementById('response').textContent = '// ここにレスポンスが表示されます';
        }

        async function getToken() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await getCsrfCookie();
                const res = await fetch('/api/auth/token', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Accept': 'application/json',
                        'X-XSRF-TOKEN': getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ email, password, device_name: 'test-ui' })
                });
                const data = await res.json();
                log('POST', '/api/auth/token', res.status, data);
                
                if (data.token) {
                    token = data.token;
                    localStorage.setItem('limin_token', token);
                    document.getElementById('currentToken').textContent = token.substring(0, 30) + '...';
                }
            } catch (e) {
                log('POST', '/api/auth/token', 'ERROR', { error: e.message });
            }
        }

        async function logout() {
            try {
                await getCsrfCookie();
                const res = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-XSRF-TOKEN': getCsrfToken()
                    },
                    credentials: 'same-origin'
                });
                log('POST', '/api/auth/logout', res.status, res.status === 204 ? 'Success' : await res.json());
                
                if (res.status === 204) {
                    token = '';
                    localStorage.removeItem('limin_token');
                    document.getElementById('currentToken').textContent = '未取得';
                }
            } catch (e) {
                log('POST', '/api/auth/logout', 'ERROR', { error: e.message });
            }
        }

        async function capture() {
            const text = document.getElementById('captureText').value;
            
            try {
                await getCsrfCookie();
                const res = await fetch('/api/capture', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-XSRF-TOKEN': getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                log('POST', '/api/capture', res.status, data);
                
                if (data.id) {
                    document.getElementById('deleteItemId').value = data.id;
                    document.getElementById('updateItemId').value = data.id;
                }
            } catch (e) {
                log('POST', '/api/capture', 'ERROR', { error: e.message });
            }
        }

        async function deleteItem() {
            const id = document.getElementById('deleteItemId').value;
            
            try {
                await getCsrfCookie();
                const res = await fetch(`/api/item/${id}`, {
                    method: 'DELETE',
                    headers: { 
                        'Accept': 'application/json', 
                        'Authorization': `Bearer ${token}`,
                        'X-XSRF-TOKEN': getCsrfToken()
                    },
                    credentials: 'same-origin'
                });
                
                if (res.status === 204) {
                    log('DELETE', `/api/item/${id}`, res.status, 'Success');
                } else {
                    const data = await res.json();
                    log('DELETE', `/api/item/${id}`, res.status, data);
                }
            } catch (e) {
                log('DELETE', `/api/item/${id}`, 'ERROR', { error: e.message });
            }
        }

        async function updateNextAction() {
            const id = document.getElementById('updateItemId').value;
            const nextAction = document.getElementById('nextAction').value;
            
            try {
                await getCsrfCookie();
                const res = await fetch(`/api/item/${id}/next-action`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-XSRF-TOKEN': getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ next_action: nextAction })
                });
                
                if (res.status === 204) {
                    log('POST', `/api/item/${id}/next-action`, res.status, 'Success');
                } else {
                    const data = await res.json();
                    log('POST', `/api/item/${id}/next-action`, res.status, data);
                }
            } catch (e) {
                log('POST', `/api/item/${id}/next-action`, 'ERROR', { error: e.message });
            }
        }
    </script>
</body>
</html>

